<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The Eight Numbers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #e0e5ec;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        /* Neumorphism Utilities */
        .neu-out {
            background: #e0e5ec;
            box-shadow: 9px 9px 16px rgb(163, 177, 198, 0.6), -9px -9px 16px rgba(255, 255, 255, 0.5);
        }

        .neu-in {
            background: #e0e5ec;
            box-shadow: inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7), inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
        }

        .neu-btn {
            background: #e0e5ec;
            box-shadow: 6px 6px 10px 0 rgba(163, 177, 198, 0.7), -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
        }

        .neu-btn:active {
            box-shadow: inset 4px 4px 8px 0 rgba(163, 177, 198, 0.7), inset -4px -4px 8px 0 rgba(255, 255, 255, 0.8);
        }

        .glow-green {
            box-shadow: 0 0 15px #4ade80, inset 0 0 10px #4ade80;
            border: 2px solid #4ade80;
        }

        .glow-red {
            box-shadow: 0 0 15px #ef4444, inset 0 0 10px #ef4444;
            border: 2px solid #ef4444;
        }

        .glow-blue {
            box-shadow: 0 0 15px #3b82f6, inset 0 0 10px #3b82f6;
            border: 2px solid #3b82f6;
        }

        /* Tooltip Animation */
        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            10% {
                opacity: 1;
                transform: translateY(0);
            }

            90% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .tooltip-anim {
            animation: fadeInOut 2s ease-in-out forwards;
        }
    </style>
</head>

<body>
    <div id="root" class="h-screen w-screen flex flex-col items-center justify-center"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Configuration ---
        const NODES = [
            { id: 0, x: 50, y: 10, label: 'A' },
            { id: 1, x: 20, y: 35, label: 'B' },
            { id: 2, x: 50, y: 35, label: 'C' },
            { id: 3, x: 80, y: 35, label: 'D' },
            { id: 4, x: 20, y: 65, label: 'E' },
            { id: 5, x: 50, y: 65, label: 'F' },
            { id: 6, x: 80, y: 65, label: 'G' },
            { id: 7, x: 50, y: 90, label: 'H' },
        ];

        const CONNECTIONS = [
            [1, 2, 3],          // 0
            [0, 2, 4, 5],       // 1
            [0, 1, 3, 4, 5, 6], // 2
            [0, 2, 5, 6],       // 3
            [1, 2, 5, 7],       // 4
            [1, 2, 3, 4, 6, 7], // 5
            [2, 3, 5, 7],       // 6
            [4, 5, 6]           // 7
        ];

        const NUMBERS = [1, 2, 3, 4, 5, 6, 7, 8];

        function App() {
            const [board, setBoard] = useState(Array(8).fill(null));
            const [availableNumbers, setAvailableNumbers] = useState(NUMBERS);
            const [startTime, setStartTime] = useState(null);
            const [endTime, setEndTime] = useState(null);
            const [isWon, setIsWon] = useState(false);
            const [tooltip, setTooltip] = useState({ show: false, text: '', x: 0, y: 0 });
            const [draggedNumber, setDraggedNumber] = useState(null);
            const [hoveredNode, setHoveredNode] = useState(null);
            const [history, setHistory] = useState([]);
            const [selectedNumber, setSelectedNumber] = useState(null); // For mobile tap interaction

            useEffect(() => {
                setStartTime(Date.now());
            }, []);

            useEffect(() => {
                if (board.every(n => n !== null)) {
                    checkWin();
                }
            }, [board]);

            const checkWin = () => {
                let valid = true;
                for (let i = 0; i < 8; i++) {
                    if (!checkNodeValidity(i, board[i], board)) {
                        valid = false;
                        break;
                    }
                }
                if (valid) {
                    setIsWon(true);
                    setEndTime(Date.now());
                }
            };

            const checkNodeValidity = (nodeId, number, currentBoard) => {
                const neighbors = CONNECTIONS[nodeId];
                for (let neighborId of neighbors) {
                    const neighborVal = currentBoard[neighborId];
                    if (neighborVal !== null) {
                        if (Math.abs(neighborVal - number) === 1) {
                            return { valid: false, conflict: neighborVal };
                        }
                    }
                }
                return { valid: true };
            };

            const addToHistory = () => {
                setHistory(prev => [...prev, [...board]]);
            };

            const handleUndo = () => {
                if (history.length === 0) return;
                const prevBoard = history[history.length - 1];
                setBoard(prevBoard);
                setHistory(prev => prev.slice(0, -1));
            };

            const handleDrop = (nodeId, number) => {
                const check = checkNodeValidity(nodeId, number, board);
                if (check.valid) {
                    addToHistory();
                    const newBoard = [...board];

                    const existingIdx = newBoard.indexOf(number);
                    if (existingIdx !== -1) {
                        newBoard[existingIdx] = null;
                    }

                    newBoard[nodeId] = number;
                    setBoard(newBoard);
                    setSelectedNumber(null); // Clear selection after placement
                } else {
                    // Show error feedback
                }
                setHoveredNode(null);
            };

            const handleReturnToPool = (number) => {
                const idx = board.indexOf(number);
                if (idx !== -1) {
                    addToHistory();
                    const newBoard = [...board];
                    newBoard[idx] = null;
                    setBoard(newBoard);
                }
            };

            const handleKeyDown = (e, nodeId) => {
                if (isWon) return;

                const key = parseInt(e.key);
                if (NUMBERS.includes(key)) {
                    const check = checkNodeValidity(nodeId, key, board);
                    if (check.valid) {
                        addToHistory();
                        const newBoard = [...board];
                        const existingIdx = newBoard.indexOf(key);
                        if (existingIdx !== -1) newBoard[existingIdx] = null;

                        newBoard[nodeId] = key;
                        setBoard(newBoard);
                    } else {
                        showTooltip(`Too close to ${check.conflict}!`, e.target.getBoundingClientRect());
                    }
                }
            };

            const showTooltip = (text, rect) => {
                setTooltip({
                    show: true,
                    text,
                    x: rect.left + rect.width / 2,
                    y: rect.top - 10
                });
                setTimeout(() => setTooltip({ ...tooltip, show: false }), 2000);
            };

            // Mobile: Tap to select number from pool or node
            const handleNumberClick = (num) => {
                if (isWon) return;
                const isUsed = board.includes(num);
                if (!isUsed) {
                    setSelectedNumber(num);
                }
            };

            // Mobile: Tap node to place selected number or select number from node
            const handleNodeClick = (nodeId) => {
                if (isWon) return;

                const value = board[nodeId];

                if (selectedNumber !== null) {
                    // Place selected number
                    handleDrop(nodeId, selectedNumber);
                } else if (value !== null) {
                    // Select number from node to move it
                    setSelectedNumber(value);
                }
            };

            const getUsedNumbers = () => board.filter(n => n !== null);

            return (
                <div className="w-full max-w-4xl h-full flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 p-2 md:p-4">

                    {/* Game Board */}
                    <div className="relative w-[300px] h-[300px] sm:w-[400px] sm:h-[400px] md:w-[500px] md:h-[500px] select-none">
                        {/* Lines */}
                        <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
                            {CONNECTIONS.map((neighbors, fromId) =>
                                neighbors.map(toId => {
                                    if (fromId < toId) {
                                        const from = NODES[fromId];
                                        const to = NODES[toId];
                                        return (
                                            <line
                                                key={`${fromId}-${toId}`}
                                                x1={`${from.x}%`} y1={`${from.y}%`}
                                                x2={`${to.x}%`} y2={`${to.y}%`}
                                                stroke="#a3b1c6"
                                                strokeWidth="3"
                                                strokeLinecap="round"
                                            />
                                        );
                                    }
                                    return null;
                                })
                            )}
                        </svg>

                        {/* Nodes */}
                        {NODES.map((node) => {
                            const value = board[node.id];
                            const isHovered = hoveredNode?.id === node.id;
                            const isInvalidHover = isHovered && !hoveredNode.isValid;
                            const isSelected = value === selectedNumber;

                            return (
                                <div
                                    key={node.id}
                                    className={`absolute flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full text-xl sm:text-2xl font-bold transition-all duration-200 outline-none
                                        ${value ? 'neu-out text-gray-700' : 'neu-in text-gray-400'}
                                        ${isWon ? 'glow-green' : ''}
                                        ${isInvalidHover ? 'glow-red' : ''}
                                        ${isSelected ? 'glow-blue' : ''}
                                        ${!isWon && value && !isInvalidHover ? 'border-2 border-transparent' : ''}
                                    `}
                                    style={{
                                        left: `${node.x}%`,
                                        top: `${node.y}%`,
                                        transform: 'translate(-50%, -50%)',
                                        cursor: isWon ? 'default' : 'pointer'
                                    }}
                                    tabIndex={isWon ? -1 : 0}
                                    onKeyDown={(e) => handleKeyDown(e, node.id)}
                                    onClick={() => handleNodeClick(node.id)}
                                    draggable={!!value && !isWon}
                                    onDragStart={(e) => {
                                        if (value && !isWon) {
                                            setDraggedNumber(value);
                                        }
                                    }}
                                    onDragOver={(e) => {
                                        e.preventDefault();
                                        if (draggedNumber && !isWon) {
                                            const check = checkNodeValidity(node.id, draggedNumber, board);
                                            setHoveredNode({ id: node.id, isValid: check.valid });
                                        }
                                    }}
                                    onDragLeave={() => setHoveredNode(null)}
                                    onDrop={(e) => {
                                        e.preventDefault();
                                        if (draggedNumber && !isWon) {
                                            handleDrop(node.id, draggedNumber);
                                        }
                                    }}
                                >
                                    {value}
                                </div>
                            );
                        })}
                    </div>

                    {/* Controls & Pool */}
                    <div className="flex flex-col items-center gap-4 md:gap-8 z-10">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-700 tracking-wider">THE EIGHT NUMBERS</h1>

                        <div
                            className="neu-out p-4 md:p-6 rounded-2xl flex flex-col items-center gap-3 md:gap-4 border-2 border-gray-300"
                            onDragOver={(e) => e.preventDefault()}
                            onDrop={(e) => {
                                e.preventDefault();
                                if (draggedNumber) {
                                    handleReturnToPool(draggedNumber);
                                }
                            }}
                        >
                            <h2 className="text-gray-500 font-semibold text-sm md:text-base">Drag/Tap Numbers</h2>
                            <div className="grid grid-cols-4 gap-3 md:gap-4">
                                {NUMBERS.map(num => {
                                    const isUsed = board.includes(num);
                                    const isSelected = num === selectedNumber;
                                    return (
                                        <div
                                            key={num}
                                            draggable={!isUsed && !isWon}
                                            onDragStart={() => setDraggedNumber(num)}
                                            onDragEnd={() => {
                                                setDraggedNumber(null);
                                                setHoveredNode(null);
                                            }}
                                            onClick={() => handleNumberClick(num)}
                                            className={`w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full font-bold text-base sm:text-lg transition-all
                                                ${isUsed
                                                    ? 'neu-in text-gray-300 cursor-not-allowed'
                                                    : 'neu-out text-gray-700 cursor-pointer active:scale-95 hover:-translate-y-1'}
                                                ${isSelected ? 'glow-blue' : ''}
                                            `}
                                        >
                                            {num}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="text-gray-500 text-xs md:text-sm max-w-xs text-center px-2">
                            <p>Rule: Connected nodes cannot have consecutive numbers (e.g., 1 cannot connect to 2).</p>
                            <p className="mt-1 text-xs text-gray-400">Mobile: Tap number, then tap node</p>
                        </div>

                        <div className="flex gap-2 md:gap-4 flex-wrap justify-center">
                            <button
                                onClick={() => {
                                    setBoard(Array(8).fill(null));
                                    setStartTime(Date.now());
                                    setIsWon(false);
                                    setEndTime(null);
                                    setHistory([]);
                                    setSelectedNumber(null);
                                }}
                                className="px-4 md:px-6 py-2 neu-btn rounded-full text-sm md:text-base text-gray-600 font-semibold hover:text-red-500 active:scale-95"
                            >
                                Reset
                            </button>
                            <button
                                onClick={handleUndo}
                                disabled={history.length === 0 || isWon}
                                className={`px-4 md:px-6 py-2 neu-btn rounded-full text-sm md:text-base font-semibold active:scale-95
                                    ${history.length === 0 || isWon ? 'text-gray-400 cursor-not-allowed' : 'text-gray-600 hover:text-blue-500'}
                                `}
                            >
                                Undo
                            </button>
                        </div>

                        {isWon && (
                            <div className="neu-out p-4 md:p-6 rounded-xl flex flex-col items-center gap-2 animate-bounce">
                                <h3 className="text-xl md:text-2xl font-bold text-green-600">Congratulations!</h3>
                                <p className="text-sm md:text-base text-gray-600">Time Taken: {((endTime - startTime) / 1000).toFixed(1)}s</p>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="mt-2 px-4 md:px-6 py-2 neu-btn rounded-full text-sm md:text-base text-gray-700 font-semibold hover:text-blue-500"
                                >
                                    Play Again
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Tooltip */}
                    {tooltip.show && (
                        <div
                            className="fixed z-50 px-4 py-2 bg-red-500 text-white text-sm font-bold rounded-lg shadow-lg pointer-events-none tooltip-anim"
                            style={{
                                left: tooltip.x,
                                top: tooltip.y,
                                transform: 'translate(-50%, -100%)'
                            }}
                        >
                            {tooltip.text}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>